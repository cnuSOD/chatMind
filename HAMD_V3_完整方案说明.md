# HAMD V3 å¿ƒç†è¯„ä¼°ç³»ç»Ÿ - Phase 3 å®Œæ•´æ–¹æ¡ˆ

## ğŸ“‹ æ¦‚è¿°

è¿™æ˜¯å“ˆå¯†å°”é¡¿æŠ‘éƒé‡è¡¨ï¼ˆHAMDï¼‰çš„ç¬¬ä¸‰ä»£æ™ºèƒ½è¯„ä¼°ç³»ç»Ÿï¼Œå®ç°äº†**ä¸‰é˜¶æ®µåŠ¨æ€è¯„ä¼°**ã€**LLMè‡ªç„¶æé—®**ã€**æ™ºèƒ½è¿½é—®**ã€**æƒ…ç»ªæ„ŸçŸ¥**å’Œ**é«˜é£é™©ç›‘æ§**ç­‰é«˜çº§åŠŸèƒ½ã€‚

## ğŸ¯ æ ¸å¿ƒç‰¹æ€§

### 1. ä¸‰é˜¶æ®µè¯„ä¼°æ¶æ„

```
é˜¶æ®µ1ï¼šåˆæ­¥ç­›æŸ¥ï¼ˆ5é¢˜ï¼‰
â”œâ”€â”€ æŠ‘éƒæƒ…ç»ªï¼ˆé¢˜1ï¼‰         â­ æ ¸å¿ƒæŒ‡æ ‡
â”œâ”€â”€ ç¡çœ éšœç¢ï¼ˆé¢˜4ï¼‰         
â”œâ”€â”€ å…´è¶£ä¸§å¤±ï¼ˆé¢˜6ï¼‰         â­ æ ¸å¿ƒæŒ‡æ ‡
â”œâ”€â”€ ç„¦è™‘ï¼ˆé¢˜9ï¼‰             
â””â”€â”€ æ— åŠ›æ„Ÿï¼ˆé¢˜13ï¼‰          

â†“ è‡ªåŠ¨è¿›å…¥é˜¶æ®µ2

é˜¶æ®µ2ï¼šæ·±å…¥è¯„ä¼°ï¼ˆ6é¢˜ï¼‰
â”œâ”€â”€ è‡ªæ€æ„å›¾ï¼ˆé¢˜3ï¼‰         ğŸš¨ é«˜é£é™©æŒ‡æ ‡
â”œâ”€â”€ æœ‰ç½ªæ„Ÿï¼ˆé¢˜2ï¼‰           
â”œâ”€â”€ ç²¾ç¥è¿åŠ¨è¿Ÿç¼“ï¼ˆé¢˜8ï¼‰     
â”œâ”€â”€ è‡ªæˆ‘è¯„ä»·ï¼ˆé¢˜10ï¼‰        
â”œâ”€â”€ é£Ÿæ¬²å‡é€€ï¼ˆé¢˜5ï¼‰         
â””â”€â”€ æƒ…æ„Ÿå¹³æ·¡ï¼ˆé¢˜11ï¼‰        

â†“ è‡ªåŠ¨è¿›å…¥é˜¶æ®µ3

é˜¶æ®µ3ï¼šå…¨é¢è¯„ä¼°ï¼ˆ5é¢˜ï¼‰
â”œâ”€â”€ ä½“é‡å‡è½»ï¼ˆé¢˜7ï¼‰         
â”œâ”€â”€ ç§¯ææ€§ï¼ˆé¢˜14ï¼‰          
â”œâ”€â”€ æ€§å…´è¶£å‡é€€ï¼ˆé¢˜12ï¼‰      
â”œâ”€â”€ æ„ŸçŸ¥èƒ½åŠ›ï¼ˆé¢˜15ï¼‰        
â””â”€â”€ å…¶ä»–ç—‡çŠ¶ï¼ˆé¢˜16ï¼‰        
```

### 2. LLMåŠ¨æ€æé—®

**ä¼ ç»Ÿé—®æ³•ï¼ˆç”Ÿç¡¬ï¼‰ï¼š**
> "æ‚¨æœ€è¿‘å‡ å¤©æœ‰æ²¡æœ‰è§‰å¾—å¿ƒæƒ…ä½è½ã€æ‚²ä¼¤ã€ç»æœ›æˆ–å¤±å»å…´è¶£ï¼Ÿ"

**V3åŠ¨æ€ç”Ÿæˆï¼ˆè‡ªç„¶ï¼‰ï¼š**
> "æœ€è¿‘å¿ƒæƒ…æ€ä¹ˆæ ·ï¼Ÿæœ‰æ²¡æœ‰è§‰å¾—ç‰¹åˆ«éš¾è¿‡æˆ–è€…æä¸èµ·åŠ²ï¼Ÿ"
> "è¿™å‡ å¤©æ„Ÿè§‰å¼€å¿ƒå—ï¼Ÿè¿˜æ˜¯ç»å¸¸ä¼šæ„Ÿåˆ°å¿ƒæƒ…ä½è½ï¼Ÿ"
> "èƒ½è¯´è¯´æ‚¨æœ€è¿‘çš„å¿ƒæƒ…çŠ¶æ€å—ï¼Ÿæœ‰ä»€ä¹ˆæ„Ÿå—ï¼Ÿ"

**å®ç°åŸç†ï¼š**
```python
# æ ¹æ®é—®é¢˜æ„å›¾ + ä¸Šä¸‹æ–‡ + æƒ…ç»ªçŠ¶æ€ â†’ LLMç”Ÿæˆè‡ªç„¶é—®æ³•
question_prompt = evaluator.get_question_prompt()

# æ¯æ¬¡æé—®éƒ½æ˜¯æ–°çš„ï¼Œè€ƒè™‘ï¼š
# 1. é—®é¢˜è¯„ä¼°ç›®çš„ï¼ˆintent_descriptionï¼‰
# 2. ä¹‹å‰çš„å¯¹è¯å†…å®¹ï¼ˆconversation_historyï¼‰
# 3. ç”¨æˆ·å½“å‰æƒ…ç»ªï¼ˆemotional_contextï¼‰
# 4. é—®é¢˜ä¼˜å…ˆçº§å’Œé£é™©ç­‰çº§
```

### 3. æ™ºèƒ½è¿½é—®æœºåˆ¶

**è§¦å‘æ¡ä»¶ï¼š**
- å›ç­”æ¸…æ™°åº¦ < 0.5ï¼ˆæ¨¡ç³Šå›ç­”ï¼‰
- é«˜é£é™©é—®é¢˜ï¼ˆè‡ªæ€æ„å›¾ï¼‰ä¸”æ¸…æ™°åº¦ < 0.8
- æœªè¾¾åˆ°æœ€å¤§è¿½é—®æ¬¡æ•°ï¼ˆé»˜è®¤2æ¬¡ï¼‰

**ç¤ºä¾‹ï¼š**

```
é—®ï¼šæœ€è¿‘å¿ƒæƒ…æ€ä¹ˆæ ·ï¼Ÿ
ç­”ï¼šè¿˜è¡Œå§ã€‚                          # æ¸…æ™°åº¦è¯„åˆ†ï¼š0.3ï¼ˆæ¨¡ç³Šï¼‰

è¿½é—®1ï¼šèƒ½å…·ä½“è¯´è¯´æ˜¯ä»€ä¹ˆæ„Ÿè§‰å—ï¼Ÿ
ç­”ï¼šå°±æ˜¯æœ‰æ—¶å€™ä¼šä¸å¤ªå¼€å¿ƒã€‚          # æ¸…æ™°åº¦è¯„åˆ†ï¼š0.5ï¼ˆä¸€èˆ¬ï¼‰

è¿½é—®2ï¼šè¿™ç§ä¸å¼€å¿ƒçš„æ„Ÿè§‰ç»å¸¸å‡ºç°å—ï¼Ÿä¼šå½±å“åˆ°æ—¥å¸¸ç”Ÿæ´»å—ï¼Ÿ
ç­”ï¼šæ¯å¤©éƒ½ä¼šæœ‰ï¼Œåšä»€ä¹ˆéƒ½æä¸èµ·åŠ²ã€‚  # æ¸…æ™°åº¦è¯„åˆ†ï¼š0.9ï¼ˆæ¸…æ™°ï¼‰

â†’ è¯„åˆ†ï¼š2åˆ†ï¼ˆæ˜ç¡®æƒ…ç»ªä½è½ï¼Œå½±å“æ—¥å¸¸ï¼‰
```

### 4. æƒ…ç»ªæ„ŸçŸ¥ä¸é£æ ¼è°ƒæ•´

**æƒ…ç»ªåˆ†æï¼š**
```python
{
    "emotion": "negative",      # positive/neutral/negative/critical
    "intensity": 7,             # 0-10åˆ†
    "keywords": ["æ‚²ä¼¤", "ç»æœ›", "ç—›è‹¦"]
}
```

**è‡ªé€‚åº”è¯­æ°”ï¼š**

| æƒ…ç»ªçŠ¶æ€ | å¼ºåº¦ | è¯­æ°”ç­–ç•¥ | ç¤ºä¾‹ |
|---------|------|---------|------|
| critical | 8-10 | æåº¦æ¸©å’Œã€å……æ»¡å…³æ€€ | "æˆ‘ç†è§£æ‚¨ç°åœ¨å¾ˆä¸å®¹æ˜“ï¼Œå’±ä»¬æ…¢æ…¢è¯´..." |
| negative | 5-7 | æ¸©æš–ã€å…±æƒ… | "å¬èµ·æ¥æ‚¨æœ€è¿‘ç¡®å®æŒºéš¾çš„ï¼Œèƒ½å†è¯´è¯´å—ï¼Ÿ" |
| neutral | 2-4 | è‡ªç„¶ã€äº²åˆ‡ | "å¥½çš„ï¼Œé‚£æˆ‘ä»¬ç»§ç»­ä¸‹ä¸€ä¸ªé—®é¢˜" |
| positive | 0-1 | è½»æ¾ã€å‹å¥½ | "å¬èµ·æ¥ä¸é”™ï¼Œç»§ç»­ä¿æŒå“¦" |

### 5. é«˜é£é™©å®æ—¶ç›‘æ§

**ç›‘æ§æŒ‡æ ‡ï¼š**
- **è‡ªæ€é£é™©è¯„åˆ†**ï¼šé¢˜3ï¼ˆè‡ªæ€æ„å›¾ï¼‰â‰¥ 2åˆ† â†’ ç«‹å³æ ‡è®°
- **æƒ…ç»ªå¼ºåº¦**ï¼šintensity â‰¥ 8 â†’ é£é™©ç­‰çº§å‡çº§
- **å…³é”®è¯æ£€æµ‹**ï¼š["æƒ³æ­»", "è‡ªæ€", "æ´»ç€æ²¡æ„æ€", "è§£è„±"]

**é£é™©ç­‰çº§ï¼š**
```python
risk_level = {
    "low":      "æ­£å¸¸ï¼Œæ— é£é™©",
    "medium":   "ä¸­ç­‰é£é™©ï¼Œéœ€è¦å…³æ³¨",
    "high":     "é«˜é£é™©ï¼Œå»ºè®®ä¸“ä¸šå¸®åŠ©",
    "critical": "ğŸš¨æé«˜é£é™©ï¼Œç´§æ€¥å¹²é¢„"
}
```

**è§¦å‘åŠ¨ä½œï¼š**
1. æ§åˆ¶å°è­¦æŠ¥ï¼š`[è­¦æŠ¥] æ£€æµ‹åˆ°é«˜é£é™©æƒ…å†µï¼`
2. æŠ¥å‘Šæ ‡è®°ï¼š`high_risk_detected: true`
3. ä¼˜å…ˆçº§æå‡ï¼šè‡ªæ€ç›¸å…³é—®é¢˜ä¼˜å…ˆè¯¢é—®
4. å»ºè®®ç”Ÿæˆï¼šè‡ªåŠ¨æ·»åŠ å±æœºçƒ­çº¿ä¿¡æ¯

### 6. å¤šè½®å¯¹è¯ä¸Šä¸‹æ–‡è®°å¿†

**è®°å¿†å†…å®¹ï¼š**
```python
conversation_history = [
    {
        "question_title": "æŠ‘éƒæƒ…ç»ª",
        "question_id": 1,
        "answer": "æœ€è¿‘å¿ƒæƒ…ç¡®å®ä¸å¤ªå¥½ï¼Œç»å¸¸æ„Ÿåˆ°æ‚²ä¼¤",
        "score": 2,
        "emotion": {"emotion": "negative", "intensity": 6},
        "clarity": 0.8,
        "timestamp": 1234567890
    },
    # ... æ›´å¤šå¯¹è¯è®°å½•
]
```

**ä¸Šä¸‹æ–‡åˆ©ç”¨ï¼š**
1. **æé—®æ—¶**ï¼šç»“åˆä¹‹å‰çš„å›ç­”ï¼Œè‡ªç„¶è¿‡æ¸¡
   ```
   å‰é¢æ‚¨æåˆ°ç»å¸¸æ„Ÿåˆ°æ‚²ä¼¤ï¼Œé‚£ç¡çœ æ–¹é¢æ€ä¹ˆæ ·å‘¢ï¼Ÿ
   ```

2. **è¯„åˆ†æ—¶**ï¼šç†è§£ä¸Šä¸‹æ–‡ï¼Œé¿å…å­¤ç«‹è¯„åˆ†
   ```
   ç”¨æˆ·å‰é¢æåˆ°"å¯¹ä»€ä¹ˆéƒ½æ²¡å…´è¶£"ï¼Œç°åœ¨è¯´"åšäº‹å¾ˆç´¯"ï¼Œ
   å¯èƒ½å­˜åœ¨æŠ‘éƒå¯¼è‡´çš„ç–²åŠ³æ„Ÿã€‚
   ```

3. **è¿½é—®æ—¶**ï¼šé’ˆå¯¹æ€§è¿½é—®ï¼Œä¸é‡å¤
   ```
   æ‚¨åˆšæ‰è¯´"æœ‰æ—¶å€™ä¼šä¸å¼€å¿ƒ"ï¼Œèƒ½è¯´è¯´å¤§æ¦‚å¤šä¹…ä¼šæœ‰ä¸€æ¬¡å—ï¼Ÿ
   ```

## ğŸ“ æ–‡ä»¶ç»“æ„

```
ASR-LLM-TTS-master/
â”œâ”€â”€ hamd_questions_v3.json          # é—®é¢˜é…ç½®ï¼ˆä¸‰é˜¶æ®µï¼‰
â”œâ”€â”€ hamd_evaluator_v3.py            # è¯„ä¼°å™¨æ ¸å¿ƒé€»è¾‘
â”œâ”€â”€ 15.2_SenceVoice_QWen2.5_HAMD_V3.py  # ä¸»ç¨‹åºé›†æˆ
â”œâ”€â”€ HAMD_V3_å®Œæ•´æ–¹æ¡ˆè¯´æ˜.md          # æœ¬æ–‡æ¡£
â””â”€â”€ HAMD_Results/                   # è¯„ä¼°æŠ¥å‘Šè¾“å‡ºç›®å½•
```

## ğŸ”§ é…ç½®è¯´æ˜

### hamd_questions_v3.json

```json
{
    "index": 1,                    // é¢˜ç›®ç¼–å·ï¼ˆ1-16ï¼‰
    "stage": 1,                    // æ‰€å±é˜¶æ®µï¼ˆ1/2/3ï¼‰
    "priority": "high",            // ä¼˜å…ˆçº§ï¼šcritical/high/medium/low
    "title": "æŠ‘éƒæƒ…ç»ª",           // é¢˜ç›®æ ‡é¢˜
    "intent_description": "è¯„ä¼°ç”¨æˆ·æœ€è¿‘çš„å¿ƒå¢ƒçŠ¶æ€...",  // è¯„ä¼°ç›®çš„
    "question": "æ‚¨æœ€è¿‘å‡ å¤©æœ‰æ²¡æœ‰è§‰å¾—å¿ƒæƒ…ä½è½...",    // åŸé—®é¢˜ï¼ˆå¤‡ç”¨ï¼‰
    "question_variants": [         // å¤šç§é—®æ³•ç¤ºä¾‹
        "æœ€è¿‘å¿ƒæƒ…æ€ä¹ˆæ ·ï¼Ÿ",
        "è¿™å‡ å¤©æ„Ÿè§‰å¼€å¿ƒå—ï¼Ÿ",
        "..."
    ],
    "follow_up_hints": [           // è¿½é—®æç¤º
        "èƒ½å…·ä½“è¯´è¯´æ˜¯ä»€ä¹ˆæ—¶å€™å¼€å§‹çš„å—ï¼Ÿ",
        "..."
    ],
    "emotion_keywords": {          // æƒ…ç»ªå…³é”®è¯ï¼ˆè¾…åŠ©è¯†åˆ«ï¼‰
        "negative": ["æ‚²ä¼¤", "éš¾è¿‡", "..."],
        "positive": ["å¼€å¿ƒ", "è¿˜å¥½", "..."]
    },
    "scoring": {                   // è¯„åˆ†æ ‡å‡†ï¼ˆ0-4åˆ†ï¼‰
        "0": "æƒ…ç»ªè‰¯å¥½ï¼Œæ— æŠ‘éƒè¡¨ç°",
        "1": "è½»åº¦ä¸å¿«ï¼Œå¶å°”å¿ƒæƒ…ä½è½",
        "..."
    }
}
```

### é˜¶æ®µè½¬æ¢é…ç½®

```python
# åœ¨ hamd_evaluator_v3.py ä¸­é…ç½®
# V3ç‰ˆæœ¬é‡‡ç”¨è‡ªåŠ¨é˜¶æ®µè½¬æ¢ï¼Œæ— éœ€é˜ˆå€¼åˆ¤æ–­
# æ‰€æœ‰ç”¨æˆ·éƒ½ä¼šå®Œæˆä¸‰é˜¶æ®µè¯„ä¼°ï¼ˆé™¤éä¸»åŠ¨åœæ­¢ï¼‰

# å¦‚éœ€è‡ªå®šä¹‰é˜¶æ®µè¡Œä¸ºï¼Œå¯ä»¥ä¿®æ”¹ï¼š
def get_current_question(self):
    # é˜¶æ®µ1å®Œæˆåè‡ªåŠ¨è¿›å…¥é˜¶æ®µ2
    if self.current_question_index >= len(stage1_questions):
        self.current_stage = 2
        self.current_question_index = 0
        ...
```

### è¿½é—®æ§åˆ¶

```python
# åœ¨ hamd_evaluator_v3.py ä¸­ä¿®æ”¹
self.max_follow_up = 2          # æ¯ä¸ªé—®é¢˜æœ€å¤šè¿½é—®2æ¬¡
self.follow_up_clarity_threshold = 0.5  # æ¸…æ™°åº¦ < 0.5 è§¦å‘è¿½é—®

# é«˜é£é™©é—®é¢˜ç‰¹æ®Šå¤„ç†
if current_q.get('priority') == 'critical':
    if self.last_answer_clarity < 0.8:  # æé«˜æ¸…æ™°åº¦è¦æ±‚
        return True
```

## ğŸš€ ä½¿ç”¨æ–¹æ³•

### 1. ç¯å¢ƒå‡†å¤‡

```bash
# å®‰è£…ä¾èµ–
pip install -r requirements.txt

# é…ç½®ç¯å¢ƒå˜é‡
export DASHSCOPE_API_KEY="your_api_key"     # åƒé—®APIå¯†é’¥
export OPENAI_BASE_URL="https://dashscope.aliyuncs.com/compatible-mode/v1"

# ç¡®ä¿é—®é¢˜é…ç½®æ–‡ä»¶å­˜åœ¨
ls hamd_questions_v3.json
```

### 2. ç‹¬ç«‹æµ‹è¯•è¯„ä¼°å™¨

```python
from hamd_evaluator_v3 import HAMDEvaluatorV3

# åˆ›å»ºè¯„ä¼°å™¨ï¼ˆæ— LLMæ¨¡å¼ï¼Œä½¿ç”¨è§„åˆ™fallbackï¼‰
evaluator = HAMDEvaluatorV3()

# å¼€å§‹è¯„ä¼°
evaluation_id = evaluator.start_evaluation()

# è·å–ç¬¬ä¸€ä¸ªé—®é¢˜
current_q = evaluator.get_current_question()
question_text = evaluator.get_question_prompt()
print(f"é—®é¢˜: {question_text}")

# ç”¨æˆ·å›ç­”
user_answer = "æœ€è¿‘å¿ƒæƒ…ç¡®å®ä¸å¤ªå¥½ï¼Œç»å¸¸æ„Ÿåˆ°æ‚²ä¼¤"

# å¤„ç†å›ç­”
result = evaluator.process_answer(user_answer)

# æ£€æŸ¥æ˜¯å¦éœ€è¦è¿½é—®
if result.get('need_follow_up'):
    follow_up_question = evaluator.get_question_prompt(is_follow_up=True)
    print(f"è¿½é—®: {follow_up_question}")
else:
    print(f"è¯„åˆ†: {result['score']}åˆ†")

# ... ç»§ç»­åç»­é—®é¢˜
```

### 3. é›†æˆåˆ°ä¸»ç¨‹åº

```python
# åœ¨ 15.2_SenceVoice_QWen2.5_HAMD_V3.py ä¸­

# åˆå§‹åŒ–è¯„ä¼°å™¨
hamd_evaluator = HAMDEvaluatorV3(
    questions_file="hamd_questions_v3.json",
    output_dir="./HAMD_Results/",
    chat_fn=chat_api  # ä½¿ç”¨åƒé—®API
)

# è§¦å‘è¯„ä¼°
if check_hamd_trigger(user_text):
    start_hamd_evaluation()

# å¤„ç†ç”¨æˆ·å›ç­”
if hamd_evaluation_active:
    process_hamd_answer(user_text)
```

### 4. è¿è¡Œå®Œæ•´ç³»ç»Ÿ

```bash
# è¿è¡Œä¸»ç¨‹åº
python 15.2_SenceVoice_QWen2.5_HAMD_V3.py

# ç³»ç»Ÿå¯åŠ¨åï¼š
# 1. è¯´ "å¿ƒç†è¯„ä¼°" è§¦å‘è¯„ä¼°
# 2. æŒ‰æç¤ºå›ç­”é—®é¢˜
# 3. ç³»ç»Ÿä¼šè‡ªåŠ¨ä»é˜¶æ®µ1è¿›å…¥é˜¶æ®µ2ã€é˜¶æ®µ3ï¼Œæ— éœ€ç¡®è®¤
# 4. æ”¯æŒå‘½ä»¤ï¼š
#    - "é‡å¤" - é‡å¤å½“å‰é—®é¢˜
#    - "ä¸Šä¸€é¢˜" - è¿”å›ä¸Šä¸€é¢˜
#    - "è·³è¿‡" - è·³è¿‡å½“å‰é¢˜
#    - "åœæ­¢" - ç»“æŸè¯„ä¼°
```

## ğŸ“Š è¯„ä¼°æµç¨‹ç¤ºä¾‹

### åœºæ™¯1ï¼šæ­£å¸¸æµç¨‹ï¼ˆä½é£é™©ï¼‰

```
[ç³»ç»Ÿ] æœ€è¿‘å¿ƒæƒ…æ€ä¹ˆæ ·ï¼Ÿæœ‰æ²¡æœ‰è§‰å¾—ç‰¹åˆ«éš¾è¿‡æˆ–è€…æä¸èµ·åŠ²ï¼Ÿ
[ç”¨æˆ·] è¿˜å¯ä»¥å§ï¼Œå¶å°”ä¼šæœ‰ç‚¹ä½è½
[ç³»ç»Ÿ] æˆ‘ç†è§£ï¼Œè¿™å¾ˆæ­£å¸¸ã€‚â†’ è¯„åˆ†ï¼š1åˆ†

[ç³»ç»Ÿ] æ‚¨æ™šä¸Šç¡å¾—æ€ä¹ˆæ ·ï¼Ÿå®¹æ˜“å…¥ç¡å—ï¼Ÿ
[ç”¨æˆ·] ç¡çœ è´¨é‡è¿˜ä¸é”™ï¼Œä¸€èˆ¬å¾ˆå¿«å°±èƒ½ç¡ç€
[ç³»ç»Ÿ] å¬èµ·æ¥ä¸é”™ã€‚â†’ è¯„åˆ†ï¼š0åˆ†

... ç»§ç»­é˜¶æ®µ1å‰©ä½™3é¢˜ ...

[ç³»ç»Ÿ] [è‡ªåŠ¨è¿›å…¥é˜¶æ®µ2]
[ç³»ç»Ÿ] æ‚¨æœ‰æ²¡æœ‰æƒ³è¿‡ä¼¤å®³è‡ªå·±ï¼Œæˆ–è€…è§‰å¾—æ´»ç€æ²¡æ„æ€ï¼Ÿ
[ç”¨æˆ·] æ²¡æœ‰ï¼Œä»æ¥æ²¡è¿™æ ·æƒ³è¿‡
[ç³»ç»Ÿ] æˆ‘ç†è§£ã€‚â†’ è¯„åˆ†ï¼š0åˆ†

... ç»§ç»­è¯„ä¼° ...
```

### åœºæ™¯2ï¼šéœ€è¦è¿½é—®ï¼ˆå›ç­”æ¨¡ç³Šï¼‰

```
[ç³»ç»Ÿ] æœ€è¿‘å¿ƒæƒ…æ€ä¹ˆæ ·ï¼Ÿ
[ç”¨æˆ·] ä¸å¤ªå¥½               # æ¸…æ™°åº¦ï¼š0.3
[ç³»ç»Ÿ] èƒ½å…·ä½“è¯´è¯´æ˜¯ä»€ä¹ˆæ„Ÿè§‰å—ï¼Ÿ    # è¿½é—®1
[ç”¨æˆ·] å°±æ˜¯æœ‰æ—¶å€™ä¼šéš¾è¿‡
[ç³»ç»Ÿ] è¿™ç§éš¾è¿‡çš„æ„Ÿè§‰ç»å¸¸å‡ºç°å—ï¼Ÿå¤§æ¦‚å¤šä¹…ä¼šæœ‰ä¸€æ¬¡ï¼Ÿ  # è¿½é—®2
[ç”¨æˆ·] å‡ ä¹æ¯å¤©éƒ½ä¼šæœ‰ï¼ŒæŒç»­å¤§åŠå¤©
[ç³»ç»Ÿ] æˆ‘ç†è§£ï¼Œè¿™å¾ˆä¸å®¹æ˜“ã€‚â†’ è¯„åˆ†ï¼š3åˆ†
```

### åœºæ™¯3ï¼šé«˜é£é™©æ£€æµ‹

```
[ç³»ç»Ÿ] æ‚¨æœ‰æ²¡æœ‰æƒ³è¿‡ä¼¤å®³è‡ªå·±ï¼Œæˆ–è€…è§‰å¾—æ´»ç€æ²¡æ„æ€ï¼Ÿ
[ç”¨æˆ·] æœ‰æ—¶å€™ä¼šæƒ³ï¼Œå¦‚æœä¸åœ¨äº†å¯èƒ½ä¼šè½»æ¾ä¸€äº›
[ç³»ç»Ÿ] [æƒ…ç»ªåˆ†æ: critical, intensity=9, risk_level=critical]
       [è­¦æŠ¥] æ£€æµ‹åˆ°é«˜é£é™©æƒ…å†µï¼
[ç³»ç»Ÿ] æˆ‘éå¸¸ç†è§£æ‚¨ç°åœ¨çš„æ„Ÿå—ã€‚èƒ½å†è¯¦ç»†è¯´è¯´å—ï¼Ÿ  # å¼ºåˆ¶è¿½é—®
[ç”¨æˆ·] å°±æ˜¯è§‰å¾—å¾ˆç´¯ï¼Œä¸æƒ³ç»§ç»­äº†
[ç³»ç»Ÿ] æˆ‘ç†è§£æ‚¨ç°åœ¨å¾ˆç—›è‹¦ã€‚â†’ è¯„åˆ†ï¼š3åˆ†

... ç»§ç»­è¯„ä¼° ...

[ç³»ç»Ÿ] è¯„ä¼°å®Œæˆã€‚âš ï¸ é‡è¦æé†’ï¼šå¦‚æœ‰è‡ªæ€å¿µå¤´ï¼Œ
       è¯·ç«‹å³æ‹¨æ‰“å¿ƒç†å±æœºå¹²é¢„çƒ­çº¿ï¼š400-161-9995
```

### åœºæ™¯4ï¼šå¤šé˜¶æ®µå®Œæ•´è¯„ä¼°

```
=== é˜¶æ®µ1ï¼šåˆæ­¥ç­›æŸ¥ ===
[è¿›è¡Œ5é¢˜]
æ€»åˆ†ï¼š7åˆ†

[ç³»ç»Ÿ] [è‡ªåŠ¨è¿›å…¥é˜¶æ®µ2]

=== é˜¶æ®µ2ï¼šæ·±å…¥è¯„ä¼° ===
[è¿›è¡Œ6é¢˜ï¼ŒåŒ…æ‹¬è‡ªæ€é£é™©è¯„ä¼°]
é˜¶æ®µ2æ€»åˆ†ï¼š9åˆ†ï¼Œç´¯è®¡ï¼š16åˆ†

[ç³»ç»Ÿ] [è‡ªåŠ¨è¿›å…¥é˜¶æ®µ3]

=== é˜¶æ®µ3ï¼šå…¨é¢è¯„ä¼° ===
[è¿›è¡Œ5é¢˜]
é˜¶æ®µ3æ€»åˆ†ï¼š5åˆ†ï¼Œç´¯è®¡ï¼š21åˆ†

[ç³»ç»Ÿ] è¯„ä¼°å·²ç»å®Œæˆã€‚æµ‹è¯„æ˜¾ç¤ºæ‚¨ç›®å‰å¯èƒ½æ‰¿å—ç€è¾ƒå¤§çš„å¿ƒç†å‹åŠ›ã€‚
       å»ºè®®æ‚¨å°½å¿«å¯»æ±‚ä¸“ä¸šçš„å¿ƒç†å’¨è¯¢æˆ–åŒ»ç–—å¸®åŠ©ã€‚
       è¯¦ç»†çš„è¯„ä¼°æŠ¥å‘Šå·²ç»ä¿å­˜å¥½äº†ã€‚

[æŠ¥å‘Š] 
- æ€»åˆ†ï¼š21/64
- ä¸¥é‡ç¨‹åº¦ï¼šä¸­åº¦æŠ‘éƒ
- é£é™©ç­‰çº§ï¼šhigh
- æƒ…ç»ªåˆ†æï¼šdominant_emotion=negative, avg_intensity=6.2
- å®Œæˆé˜¶æ®µï¼š1âœ“ 2âœ“ 3âœ“
```

## ğŸ“ˆ æŠ¥å‘Šè¾“å‡º

### æŠ¥å‘Šæ–‡ä»¶ç»“æ„

```json
{
  "evaluation_id": "HAMD_V3_1729123456",
  "version": "V3 (ä¸‰é˜¶æ®µæ™ºèƒ½è¯„ä¼°)",
  "total_score": 21,
  "max_score": 64,
  
  "severity_level": {
    "level": "ä¸­åº¦æŠ‘éƒ",
    "description": "æœ‰ä¸­åº¦æŠ‘éƒç—‡çŠ¶ï¼Œå»ºè®®å¯»æ±‚ä¸“ä¸šå¸®åŠ©",
    "color": "orange",
    "score_range": "21/64"
  },
  
  "detailed_scores": {
    "1": {
      "score": 3,
      "analysis": "è¯„åˆ†ï¼š3åˆ†ï¼Œç†ç”±ï¼šç”¨æˆ·æåˆ°æŒç»­æƒ…ç»ªä½è½ï¼Œå½±å“æ—¥å¸¸åŠŸèƒ½",
      "scoring_criteria": "æŒç»­æƒ…ç»ªä½è½ï¼Œéš¾ä»¥ç»´æŒæ—¥å¸¸åŠŸèƒ½"
    },
    "...": "..."
  },
  
  "category_analysis": {
    "æ ¸å¿ƒç—‡çŠ¶": {"score": 8, "max_score": 12, "percentage": 66.7, "severity": "ä¸­åº¦"},
    "ç”Ÿç†ç—‡çŠ¶": {"score": 6, "max_score": 20, "percentage": 30.0, "severity": "è½»åº¦"},
    "...": "..."
  },
  
  "emotion_analysis": {
    "average_intensity": 6.2,
    "dominant_emotion": "negative",
    "emotion_distribution": {
      "negative": 12,
      "neutral": 3,
      "critical": 1
    }
  },
  
  "risk_assessment": {
    "suicide_risk_score": 2,
    "overall_risk_level": "high",
    "high_risk_detected": true
  },
  
  "stages_completed": {
    "stage_1": true,
    "stage_2": true,
    "stage_3": true
  },
  
  "recommendations": [
    "å»ºè®®å°½å¿«å¯»æ±‚ä¸“ä¸šå¿ƒç†å’¨è¯¢æˆ–æ²»ç–—ã€‚",
    "å¯ä»¥è€ƒè™‘å¿ƒç†æ²»ç–—ï¼Œå¦‚è®¤çŸ¥è¡Œä¸ºç–—æ³•ã€‚",
    "ä¿æŒä¸å®¶äººæœ‹å‹çš„è”ç³»ï¼Œå¯»æ±‚ç¤¾ä¼šæ”¯æŒã€‚"
  ],
  
  "evaluation_time": {
    "start_time": "2024-10-20 14:30:00",
    "duration_minutes": 12.5
  }
}
```

## ğŸ” æŠ€æœ¯ç»†èŠ‚

### 1. LLM Prompt è®¾è®¡

**åŠ¨æ€æé—® Prompt:**
```python
prompt = f"""ä½ æ˜¯å¿ƒç†è¯„ä¼°åŠ©æ‰‹ï¼Œæ­£åœ¨è¿›è¡Œè¯„ä¼°çš„ç¬¬{stage}é˜¶æ®µã€‚

å½“å‰è¦è¯„ä¼°çš„ç»´åº¦ï¼š{title}
è¯„ä¼°ç›®çš„ï¼š{intent_description}

å‚è€ƒé—®æ³•ç¤ºä¾‹ï¼ˆä¸è¦ç…§æ¬ï¼‰ï¼š
{question_variants}

å¯¹è¯ä¸Šä¸‹æ–‡ï¼š
{context_summary}

å½“å‰æƒ…ç»ªçŠ¶æ€ï¼š{emotion}ï¼ˆå¼ºåº¦{intensity}/10ï¼‰

è¦æ±‚ï¼š
1. {adaptive_tone}ï¼ˆæ ¹æ®æƒ…ç»ªè°ƒæ•´è¯­æ°”ï¼‰
2. ç”¨æ—¥å¸¸å¯¹è¯çš„æ–¹å¼æé—®ï¼Œä¸è¦ç”Ÿç¡¬
3. é—®é¢˜ç®€æ´ï¼Œ20-30å­—
4. ä¸è¦æåŠ"è¯„ä¼°"ã€"é‡è¡¨"ç­‰ä¸“ä¸šæœ¯è¯­
5. ç»“åˆä¹‹å‰çš„å¯¹è¯è‡ªç„¶è¿‡æ¸¡
6. åªç”Ÿæˆé—®é¢˜æœ¬èº«ï¼Œä¸è¦å‰ç¼€å’Œè§£é‡Š

è¯·ç”Ÿæˆä¸€ä¸ªè‡ªç„¶çš„æé—®ï¼š"""
```

**è¯„åˆ† Prompt:**
```python
prompt = f"""ä½ æ˜¯ä¸“ä¸šçš„å¿ƒç†æµ‹é‡è¯„åˆ†å‘˜ã€‚

é¢˜ç›®ï¼š{question}
è¯„ä¼°ç›®çš„ï¼š{intent_description}

è¯„åˆ†æ ‡å‡†ï¼š
0åˆ†: {scoring_0}
1åˆ†: {scoring_1}
...

ç”¨æˆ·å›ç­”ï¼š"{user_answer}"

å¯¹è¯ä¸Šä¸‹æ–‡ï¼š{context}

ä¸¥æ ¼è¦æ±‚ï¼š
1) åªè¾“å‡ºï¼šè¯„åˆ†ï¼šXåˆ†ï¼Œç†ç”±ï¼š[ç®€è¦åˆ†æ]
2) ç»å¯¹ç¦æ­¢æé—®ã€è¿½é—®ã€åé—®
3) ç»å¯¹ç¦æ­¢ç»™å»ºè®®ã€å®‰æ…°ã€é¼“åŠ±
4) æ ¹æ®è¯„åˆ†æ ‡å‡†ä¸¥æ ¼è¯„åˆ†

è¾“å‡ºï¼š"""
```

### 2. æ¸…æ™°åº¦è¯„ä¼°ç®—æ³•

```python
def evaluate_answer_clarity(user_answer, question_obj):
    # LLMè¯„ä¼°ï¼ˆæ¨èï¼‰
    clarity_score = llm_evaluate_clarity(user_answer, question_obj)
    
    # è§„åˆ™è¯„ä¼°ï¼ˆå¤‡ç”¨ï¼‰
    if llm_failed:
        length_score = min(len(user_answer) / 50, 1.0)
        vague_penalty = count_vague_words(user_answer) * 0.15
        specific_bonus = count_specific_words(user_answer) * 0.2
        
        clarity_score = length_score - vague_penalty + specific_bonus
        clarity_score = max(0, min(1, clarity_score))
    
    return clarity_score
```

### 3. æƒ…ç»ªæ£€æµ‹æœºåˆ¶

```python
def analyze_user_emotion(user_answer):
    # LLMæƒ…ç»ªåˆ†æ
    emotion_data = llm_analyze_emotion(user_answer)
    
    # å…³é”®è¯å¢å¼º
    critical_keywords = ["æƒ³æ­»", "è‡ªæ€", "æ´»ç€æ²¡æ„æ€"]
    if any(kw in user_answer for kw in critical_keywords):
        emotion_data["emotion"] = "critical"
        emotion_data["intensity"] = max(emotion_data["intensity"], 9)
    
    # æ›´æ–°å…¨å±€æƒ…ç»ªä¸Šä¸‹æ–‡
    update_emotional_context(emotion_data)
    
    # åŠ¨æ€è°ƒæ•´é£é™©ç­‰çº§
    if emotion_data["emotion"] == "critical":
        risk_level = "critical"
    elif emotion_data["intensity"] >= 7:
        risk_level = "high"
    ...
    
    return emotion_data
```

### 4. é˜¶æ®µè½¬æ¢é€»è¾‘

```python
def check_stage_transition():
    # é˜¶æ®µ1å®Œæˆ â†’ è‡ªåŠ¨è¿›å…¥é˜¶æ®µ2
    if current_stage == 1 and all_questions_answered:
        current_stage = 2
        current_question_index = 0
        print(f"[HAMD-V3] è‡ªåŠ¨è¿›å…¥é˜¶æ®µ{current_stage}")
        return next_stage_first_question
    
    # é˜¶æ®µ2å®Œæˆ â†’ è‡ªåŠ¨è¿›å…¥é˜¶æ®µ3
    if current_stage == 2 and all_questions_answered:
        current_stage = 3
        current_question_index = 0
        print(f"[HAMD-V3] è‡ªåŠ¨è¿›å…¥é˜¶æ®µ{current_stage}")
        return next_stage_first_question
    
    # é˜¶æ®µ3å®Œæˆ â†’ è¯„ä¼°ç»“æŸ
    ...
```

## ğŸ¨ è‡ªå®šä¹‰æ‰©å±•

### 1. æ·»åŠ æ–°çš„æƒ…ç»ªç±»å‹

```python
# åœ¨ hamd_evaluator_v3.py ä¸­æ‰©å±•
EMOTION_TYPES = {
    "positive": "ç§¯æ",
    "neutral": "ä¸­æ€§",
    "negative": "æ¶ˆæ",
    "critical": "ä¸¥é‡æ¶ˆæ",
    "anxious": "ç„¦è™‘",      # æ–°å¢
    "apathetic": "å†·æ¼ "     # æ–°å¢
}

def analyze_user_emotion(user_answer):
    # åœ¨ LLM prompt ä¸­æ·»åŠ æ–°çš„æƒ…ç»ªç±»å‹
    emotion_types = list(EMOTION_TYPES.keys())
    ...
```

### 2. è°ƒæ•´é˜¶æ®µé¢˜ç›®åˆ†é…

```python
# ä¿®æ”¹ hamd_questions_v3.json
# å°†é¢˜ç›®çš„ stage å­—æ®µæ”¹ä¸ºç›®æ ‡é˜¶æ®µ

# ä¾‹å¦‚ï¼šå°†"é£Ÿæ¬²å‡é€€"ä»é˜¶æ®µ2ç§»åˆ°é˜¶æ®µ1
{
    "index": 5,
    "stage": 1,  # æ”¹ä¸º1
    "title": "é£Ÿæ¬²å‡é€€",
    ...
}
```

### 3. å¢åŠ æ›´å¤šé—®æ³•å˜ä½“

```python
# åœ¨ hamd_questions_v3.json ä¸­æ‰©å±• question_variants
{
    "question_variants": [
        "æœ€è¿‘å¿ƒæƒ…æ€ä¹ˆæ ·ï¼Ÿ",
        "è¿™å‡ å¤©æ„Ÿè§‰å¼€å¿ƒå—ï¼Ÿ",
        "æ‚¨æœ€è¿‘å¯¹å¹³æ—¶å–œæ¬¢çš„äº‹æƒ…è¿˜æœ‰å…´è¶£å—ï¼Ÿ",
        "èƒ½è¯´è¯´æ‚¨æœ€è¿‘çš„å¿ƒæƒ…çŠ¶æ€å—ï¼Ÿ",
        # æ–°å¢æ›´å¤šå˜ä½“
        "å¿ƒæƒ…æœ‰ä»€ä¹ˆå˜åŒ–å—ï¼Ÿ",
        "æœ€è¿‘æƒ…ç»ªç¨³å®šå—ï¼Ÿ",
        "æ‚¨è§‰å¾—è‡ªå·±æœ€è¿‘å¼€å¿ƒå—ï¼Ÿ"
    ]
}
```

### 4. è‡ªå®šä¹‰å…±æƒ…å›åº”ç­–ç•¥

```python
# åœ¨ä¸»ç¨‹åºä¸­ä¿®æ”¹
def generate_empathy_response(user_answer, emotion):
    if emotion["emotion"] == "critical":
        # ä¸¥é‡æƒ…å†µï¼šå¼ºè°ƒç†è§£å’Œæ”¯æŒ
        return "æˆ‘éå¸¸ç†è§£æ‚¨ç°åœ¨çš„æ„Ÿå—ï¼Œæ‚¨å¹¶ä¸å­¤å•ã€‚"
    elif emotion["emotion"] == "negative":
        # æ¶ˆææƒ…å†µï¼šè¡¨è¾¾å…±æƒ…
        return "æˆ‘ç†è§£ï¼Œè¿™ç¡®å®å¾ˆä¸å®¹æ˜“ã€‚"
    elif emotion["emotion"] == "neutral":
        # ä¸­æ€§æƒ…å†µï¼šç®€å•ç¡®è®¤
        return "å¥½çš„ï¼Œæˆ‘æ˜ç™½äº†ã€‚"
    else:
        # ç§¯ææƒ…å†µï¼šæ­£å‘å¼ºåŒ–
        return "å¬èµ·æ¥ä¸é”™ï¼Œç»§ç»­ä¿æŒã€‚"
```

## âš ï¸ æ³¨æ„äº‹é¡¹

### 1. ä¼¦ç†å’Œå®‰å…¨

- âš ï¸ **æœ¬ç³»ç»Ÿä»…ç”¨äºè¾…åŠ©ç­›æŸ¥ï¼Œä¸èƒ½æ›¿ä»£ä¸“ä¸šè¯Šæ–­**
- âš ï¸ **æ£€æµ‹åˆ°é«˜é£é™©æ—¶ï¼Œå¿…é¡»ç«‹å³æä¾›å±æœºå¹²é¢„çƒ­çº¿**
- âš ï¸ **è¯„ä¼°æ•°æ®åº”ä¸¥æ ¼ä¿å¯†ï¼Œéµå®ˆéšç§ä¿æŠ¤æ³•è§„**
- âš ï¸ **ä¸è¦è¿‡åº¦ä¾èµ–LLMè¯„åˆ†ï¼Œå»ºè®®äººå·¥å¤æ ¸é«˜é£é™©æ¡ˆä¾‹**

### 2. æŠ€æœ¯é™åˆ¶

- LLMå¯èƒ½ç”Ÿæˆä¸æ°å½“çš„é—®é¢˜ï¼ˆéœ€è¦è¿‡æ»¤å’Œå®¡æŸ¥ï¼‰
- æƒ…ç»ªæ£€æµ‹ä¸æ˜¯100%å‡†ç¡®ï¼ˆéœ€è¦ç»“åˆå¤šç§ä¿¡å·ï¼‰
- è¿½é—®æ¬¡æ•°å—é™ï¼ˆé¿å…ç”¨æˆ·ç–²åŠ³ï¼‰
- ç½‘ç»œå»¶è¿Ÿå¯èƒ½å½±å“ä½“éªŒï¼ˆå»ºè®®æœ¬åœ°ç¼“å­˜ï¼‰

### 3. æ€§èƒ½ä¼˜åŒ–

```python
# 1. ç¼“å­˜LLMç”Ÿæˆçš„é—®é¢˜ï¼ˆå‡å°‘é‡å¤è°ƒç”¨ï¼‰
question_cache = {}

def get_question_with_cache(question_id, context_hash):
    cache_key = f"{question_id}_{context_hash}"
    if cache_key in question_cache:
        return question_cache[cache_key]
    
    question = generate_dynamic_question(...)
    question_cache[cache_key] = question
    return question

# 2. å¼‚æ­¥å¤„ç†ï¼ˆæé«˜å“åº”é€Ÿåº¦ï¼‰
import asyncio

async def process_answer_async(user_answer):
    # å¹¶è¡Œæ‰§è¡Œï¼šæƒ…ç»ªåˆ†æ + æ¸…æ™°åº¦è¯„ä¼° + LLMè¯„åˆ†
    emotion, clarity, score = await asyncio.gather(
        analyze_emotion_async(user_answer),
        evaluate_clarity_async(user_answer),
        llm_score_async(user_answer)
    )
    ...

# 3. é™ä½LLMè°ƒç”¨é¢‘ç‡ï¼ˆä½¿ç”¨è§„åˆ™ä¼˜å…ˆï¼‰
def should_use_llm(question_priority):
    if question_priority == "critical":
        return True  # é«˜é£é™©å¿…é¡»ç”¨LLM
    elif question_priority == "high":
        return random.random() < 0.8  # 80%æ¦‚ç‡ç”¨LLM
    else:
        return random.random() < 0.5  # 50%æ¦‚ç‡ç”¨LLM
```

## ğŸ“š å‚è€ƒèµ„æ–™

- [Hamilton Depression Rating Scale (HAMD)](https://en.wikipedia.org/wiki/Hamilton_Rating_Scale_for_Depression)
- [å¿ƒç†æµ‹é‡å­¦è¯„åˆ†æ ‡å‡†](https://www.example.com)
- [LLM Prompt Engineering Best Practices](https://www.example.com)
- [å±æœºå¹²é¢„çƒ­çº¿ï¼š400-161-9995](tel:400-161-9995)

## ğŸ¤ è´¡çŒ®æŒ‡å—

æ¬¢è¿è´¡çŒ®ä»£ç å’Œæ”¹è¿›å»ºè®®ï¼

```bash
# 1. Fork æœ¬é¡¹ç›®
# 2. åˆ›å»ºç‰¹æ€§åˆ†æ”¯
git checkout -b feature/your-feature

# 3. æäº¤æ›´æ”¹
git commit -m "Add: your feature description"

# 4. æ¨é€åˆ°åˆ†æ”¯
git push origin feature/your-feature

# 5. åˆ›å»º Pull Request
```

## ğŸ“„ è®¸å¯è¯

æœ¬é¡¹ç›®é‡‡ç”¨ MIT è®¸å¯è¯ã€‚è¯¦è§ LICENSE æ–‡ä»¶ã€‚

---

**ç‰ˆæœ¬**: V3.0.0  
**æ›´æ–°æ—¶é—´**: 2024-10-20  
**ä½œè€…**: HAMD-V3 å¼€å‘å›¢é˜Ÿ

å¦‚æœ‰é—®é¢˜æˆ–å»ºè®®ï¼Œè¯·æäº¤ Issue æˆ–è”ç³»å¼€å‘å›¢é˜Ÿã€‚

