

0. anaconda\ffmpeg安装
```
    网上很多教程，自行搜索
```

```
    SenseVoiceSmall模型下载：
        自动下载：设置215行 model_dir = "iic/SenseVoiceSmall"
        手动下载：https://www.modelscope.cn/models/iic/SenseVoiceSmall/files
    
    QWen模型下载：
        自动下载：设置220行 model_name = "Qwen/Qwen2.5-1.5B-Instruct"，开启科学上网，可从huggingface自动下载
        手动下载：https://www.modelscope.cn/models/ 搜索QWen，结果中下载显存可支持模型
```

1. 创建虚拟环境
```
    conda create -n chatAudio python=3.10
    conda activate chatAudio
```
2. 安装pytorch+cuda版本，本地测试2.0以上版本均可，这里安装torch=2.3.1+cuda11.8
```
    pip install torch==2.3.1 torchvision==0.18.1 torchaudio==2.3.1 --index-url https://download.pytorch.org/whl/cu118

    其它适合自己电脑的torch+cuda版本可在torch官网查找
    https://pytorch.org/get-started/previous-versions/
```

3. 简易版本安装，不使用cosyvoice时依赖项较少
```
    pip install edge-tts==6.1.17 funasr==1.1.12 ffmpeg==1.4 opencv-python==4.10.0.84 transformers==4.45.2 webrtcvad==2.0.10 qwen-vl-utils==0.0.8 pygame==2.6.1 langid==1.1.6 langdetect==1.0.9 accelerate==0.33.0 PyAudio==0.2.14

    可执行验证：
    python 13_SenceVoice_QWen2.5_edgeTTS_realTime.py
```

至此，不调用cosyvoice作为合成的交互可成功调用了。

4. cosyvoice依赖库
```
    大家反馈较多pynini、wetext安装方法：
    conda install -c conda-forge pynini=2.1.6
    pip install WeTextProcessing --no-deps
```

5. cosyvoice其它依赖项安装（如遇到权限问题导致安装失败，以管理员形式打开终端）
```
   pip install HyperPyYAML==1.2.2 modelscope==1.15.0 onnxruntime==1.19.2 openai-whisper==20231117 importlib_resources==6.4.5 sounddevice==0.5.1 matcha-tts==0.0.7.0

   可执行验证：最终执行如果用云端大模型，可以省略安装cuda，然后用以下命令设置api
   set DASHSCOPE_API_KEY=你的api-key
    python 15.2_SenceVoice_QWen2.5_HAMD_V3.py
```

## HAMD V3 心理评估（三阶段 + 评分细则）

### 快速开始

```
    # 设置云端千问（OpenAI兼容）API Key（Windows）
    set DASHSCOPE_API_KEY=你的_api_key

    # 可选：如需自定义地址（默认已内置）
    # set OPENAI_BASE_URL=https://dashscope.aliyuncs.com/compatible-mode/v1

    # 运行评估脚本（实时语音交互 + HAMD V3）
    python 15.2_SenceVoice_QWen2.5_HAMD_V3.py
```

- **唤醒/触发**: 直接说“心理评估 / 抑郁评估 / HAMD / 抑郁测试”等即可进入评估模式。
- **ASR**: 使用 `iic/SenseVoiceSmall`（代码已设置镜像 `HF_ENDPOINT=https://hf-mirror.com`）。
- **TTS**: 默认 `edge-tts`，音色 `zh-CN-XiaoyiNeural`（可在代码中改）。
- **报告输出**: 评估完成后自动保存到 `./HAMD_Results/HAMD_Report_<ID>.json`。

### 评估流程（与代码一致）

- **三阶段**: 初筛 → 深入 → 全面；按题库优先级（critical > high > medium > low）出题。
- **动态提问**: LLM 根据上下文与情绪生成更自然的问题；回答模糊会触发追问（最多2次）。
- **高风险优先**: 自杀意图题（index=3）在深入阶段优先检查，评分≥2即标记为高风险。
- **对话语气**: 内置情绪感知，语气会根据 `critical/high/medium/low` 动态调整。

### 打分规则（0-4分/题）

- 每题自带“0-4级描述”，严格按描述判分；无关/含糊回答记 0 分。
- 自杀意图题（index=3）≥2 分 → `overall_risk_level=critical` 并触发高风险提醒。
- 最终总分为各题分数之和，严重程度分级：
  - ≤7 正常；8-17 轻度；18-23 中度；≥24 重度。

### 分项（维度）聚合

- 核心症状: 1, 2, 6
- 认知症状: 10, 15
- 生理症状: 4, 5, 7, 8, 13
- 心理症状: 3, 9, 11, 12, 14
- 其他症状: 16

维度严重度按得分百分比：<25% 正常；25-49.9% 轻度；50-74.9% 中度；≥75% 重度。

### 常用触发词（语音）

- “心理评估”“抑郁评估”“抑郁测试”“开始评估”“HAMD”等。

### 常见问题

- 听写不稳定：代码已做“心理/心里、抑郁/抑于”等常见误识别归一化；仍可在 `check_hamd_trigger` 中扩展。
- 离线运行：若不用云端LLM，评估仍可进行，但评分会使用规则回退，建议配置 DASHSCOPE_API_KEY 以获得最佳体验。

### 各题评分细则（0-4 分标准）
阶段1：初步筛查（5题）
- **1 抑郁情绪**
  - 0: 情绪良好，无抑郁表现
  - 1: 轻度不快，偶尔心情低落
  - 2: 明确情绪低落，但仍可进行日常活动
  - 3: 持续情绪低落，难以维持日常功能
  - 4: 严重抑郁，可能有自杀念头或行为

- **4 睡眠障碍**
  - 0: 睡眠正常
  - 1: 偶尔失眠，能自行恢复
  - 2: 经常失眠，需要采取措施
  - 3: 严重失眠，影响白天功能
  - 4: 失眠严重，几乎无法入睡

- **6 兴趣丧失**
  - 0: 兴趣正常，能参与日常活动
  - 1: 偶尔兴趣减退，能维持活动
  - 2: 兴趣显著减退，但仍能参加日常活动
  - 3: 兴趣丧失，难以进行日常活动
  - 4: 完全丧失兴趣，不愿进行任何活动

- **9 焦虑**
  - 0: 无焦虑症状
  - 1: 偶尔感到紧张或不安
  - 2: 经常感到焦虑，影响日常生活
  - 3: 焦虑明显，难以控制
  - 4: 焦虑严重，无法维持基本生活

- **13 无力感**
  - 0: 能正常进行日常活动
  - 1: 偶尔感到疲惫，但能恢复
  - 2: 经常感到疲劳，影响日常活动
  - 3: 极度疲劳，几乎无法维持基本活动
  - 4: 严重无力感，无法进行任何活动


阶段2：深入评估（6题）
- **3 自杀意图（高风险题）**
  - 0: 无自杀念头或行为
  - 1: 偶尔有自杀念头，但没有实施计划
  - 2: 有明确的自杀念头，偶尔考虑实施
  - 3: 自杀意图明确，并有实际计划
  - 4: 已经实施自杀行为或极高的自杀风险

- **2 有罪感**
  - 0: 没有罪恶感
  - 1: 偶尔自责，能自我缓解
  - 2: 经常内疚，自责程度较强
  - 3: 持续自我贬低
  - 4: 有罪恶妄想

- **8 精神运动性迟缓**
  - 0: 精神活力正常，活动速度与平时相当
  - 1: 偶尔有轻微迟缓，但能自行调整
  - 2: 经常感到迟缓，需努力才可完成活动
  - 3: 明显迟缓，活动需要别人帮助
  - 4: 严重迟缓，几乎无法进行任何活动

- **10 自我评价**
  - 0: 自我评价正常，无负面情绪
  - 1: 偶尔自我贬低，但能自我调节
  - 2: 明显自我贬低，影响情绪
  - 3: 极度自我贬低，产生负面行为
  - 4: 完全自我否定，伴随明显负面情绪

- **5 食欲减退**
  - 0: 食欲正常
  - 1: 偶尔食欲减退，能自行恢复
  - 2: 经常食欲不振，影响饮食
  - 3: 食欲明显减退，体重明显下降
  - 4: 完全没有食欲，体重持续下降

- **11 情感平淡**
  - 0: 情感正常，与他人关系良好
  - 1: 偶尔感到情感冷漠，能恢复
  - 2: 常感情感平淡，与他人疏远
  - 3: 情感明显平淡，难以建立联系
  - 4: 完全没有情感，无法与他人建立联系


阶段3：全面评估（5题）
- **7 体重减轻**
  - 0: 体重保持正常
  - 1: 体重略有下降，未明显影响健康
  - 2: 体重大幅下降，影响日常活动
  - 3: 体重严重下降，导致健康问题
  - 4: 体重迅速下降，严重影响健康

- **14 积极性**
  - 0: 完全有积极性，能够自发做事情
  - 1: 偶尔缺乏积极性，但能坚持
  - 2: 时常缺乏积极性，需要他人提醒
  - 3: 没有积极性，无法主动做事
  - 4: 完全没有积极性，依赖他人推动

- **12 性兴趣减退**
  - 0: 性兴趣正常
  - 1: 偶尔性兴趣减退
  - 2: 性兴趣明显减退，影响亲密关系
  - 3: 完全丧失性兴趣
  - 4: 完全丧失性兴趣，伴随显著抑郁症状

- **15 感知能力**
  - 0: 感知正常
  - 1: 偶尔感到模糊，但可以清楚感知
  - 2: 感知能力显著减退，影响日常生活
  - 3: 感知能力严重下降，生活困难
  - 4: 完全失去感知能力

- **16 其他症状**
  - 0: 无其他症状
  - 1: 有轻微症状，但不影响生活
  - 2: 有较明显症状，需关注
  - 3: 症状严重，影响功能
  - 4: 症状极其严重，影响生活
